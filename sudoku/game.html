import React, { useState, useEffect, useCallback } from 'react';
import { Pencil, Lightbulb, Undo, Play, Pause, RotateCcw, Sparkles } from 'lucide-react';

const GRID_SIZE = 9;
const BOX = 3;

const SudokuGame = () => {
  const [board, setBoard] = useState(Array(9).fill().map(() => Array(9).fill(0)));
  const [initialBoard, setInitialBoard] = useState(Array(9).fill().map(() => Array(9).fill(0)));
  const [solution, setSolution] = useState(Array(9).fill().map(() => Array(9).fill(0)));
  const [selected, setSelected] = useState(null);
  const [conflicts, setConflicts] = useState(Array(9).fill().map(() => Array(9).fill(false)));
  const [difficulty, setDifficulty] = useState('medium');
  const [isPlaying, setIsPlaying] = useState(false);
  const [time, setTime] = useState(0);
  const [pencilMode, setPencilMode] = useState(false);
  const [notes, setNotes] = useState(Array(9).fill().map(() => Array(9).fill().map(() => [])));
  const [history, setHistory] = useState([]);
  const [highlightedNum, setHighlightedNum] = useState(null);

  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => setTime(t => t + 1), 1000);
    }
    return () => clearInterval(interval);
  }, [isPlaying]);

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  const isSafe = (board, row, col, num) => {
    for (let i = 0; i < GRID_SIZE; i++) {
      if (board[row][i] === num || board[i][col] === num) return false;
    }
    const boxRow = Math.floor(row / BOX) * BOX;
    const boxCol = Math.floor(col / BOX) * BOX;
    for (let r = boxRow; r < boxRow + BOX; r++) {
      for (let c = boxCol; c < boxCol + BOX; c++) {
        if (board[r][c] === num) return false;
      }
    }
    return true;
  };

  const solveSudoku = (board) => {
    for (let row = 0; row < GRID_SIZE; row++) {
      for (let col = 0; col < GRID_SIZE; col++) {
        if (board[row][col] === 0) {
          for (let num = 1; num <= 9; num++) {
            if (isSafe(board, row, col, num)) {
              board[row][col] = num;
              if (solveSudoku(board)) return true;
              board[row][col] = 0;
            }
          }
          return false;
        }
      }
    }
    return true;
  };

  const generateSudoku = (difficulty) => {
    const board = Array(9).fill().map(() => Array(9).fill(0));
    const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
    
    const fillBoard = (b) => {
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          if (b[row][col] === 0) {
            const shuffled = [...nums].sort(() => Math.random() - 0.5);
            for (let num of shuffled) {
              if (isSafe(b, row, col, num)) {
                b[row][col] = num;
                if (fillBoard(b)) return true;
                b[row][col] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    };

    fillBoard(board);
    const solvedBoard = board.map(row => [...row]);
    
    const cellsToRemove = difficulty === 'easy' ? 35 : difficulty === 'medium' ? 45 : 55;
    const cells = [];
    for (let r = 0; r < GRID_SIZE; r++) {
      for (let c = 0; c < GRID_SIZE; c++) {
        cells.push([r, c]);
      }
    }
    cells.sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < cellsToRemove && i < cells.length; i++) {
      const [r, c] = cells[i];
      board[r][c] = 0;
    }

    return { puzzle: board, solution: solvedBoard };
  };

  const newGame = () => {
    const { puzzle, solution: sol } = generateSudoku(difficulty);
    setBoard(puzzle.map(row => [...row]));
    setInitialBoard(puzzle.map(row => [...row]));
    setSolution(sol);
    setSelected(null);
    setConflicts(Array(9).fill().map(() => Array(9).fill(false)));
    setNotes(Array(9).fill().map(() => Array(9).fill().map(() => [])));
    setHistory([]);
    setTime(0);
    setIsPlaying(true);
    setHighlightedNum(null);
  };

  useEffect(() => {
    newGame();
  }, []);

  const findConflicts = (board) => {
    const conflicts = Array(9).fill().map(() => Array(9).fill(false));
    
    for (let r = 0; r < GRID_SIZE; r++) {
      const seen = {};
      for (let c = 0; c < GRID_SIZE; c++) {
        const v = board[r][c];
        if (v === 0) continue;
        if (v in seen) {
          conflicts[r][c] = true;
          conflicts[r][seen[v]] = true;
        } else {
          seen[v] = c;
        }
      }
    }
    
    for (let c = 0; c < GRID_SIZE; c++) {
      const seen = {};
      for (let r = 0; r < GRID_SIZE; r++) {
        const v = board[r][c];
        if (v === 0) continue;
        if (v in seen) {
          conflicts[r][c] = true;
          conflicts[seen[v]][c] = true;
        } else {
          seen[v] = r;
        }
      }
    }
    
    for (let br = 0; br < GRID_SIZE; br += BOX) {
      for (let bc = 0; bc < GRID_SIZE; bc += BOX) {
        const seen = {};
        for (let r = br; r < br + BOX; r++) {
          for (let c = bc; c < bc + BOX; c++) {
            const v = board[r][c];
            if (v === 0) continue;
            if (v in seen) {
              const [pr, pc] = seen[v];
              conflicts[r][c] = true;
              conflicts[pr][pc] = true;
            } else {
              seen[v] = [r, c];
            }
          }
        }
      }
    }
    
    return conflicts;
  };

  const handleCellClick = (row, col) => {
    if (initialBoard[row][col] !== 0) return;
    setSelected([row, col]);
    if (board[row][col] !== 0) {
      setHighlightedNum(board[row][col]);
    } else {
      setHighlightedNum(null);
    }
  };

  const handleNumberInput = (num) => {
    if (!selected) return;
    const [row, col] = selected;
    if (initialBoard[row][col] !== 0) return;

    const newHistory = [...history, { board: board.map(r => [...r]), notes: notes.map(r => r.map(c => [...c])) }];
    setHistory(newHistory);

    if (pencilMode) {
      const newNotes = notes.map(r => r.map(c => [...c]));
      const cellNotes = newNotes[row][col];
      const idx = cellNotes.indexOf(num);
      if (idx > -1) {
        cellNotes.splice(idx, 1);
      } else {
        cellNotes.push(num);
        cellNotes.sort();
      }
      setNotes(newNotes);
    } else {
      const newBoard = board.map(r => [...r]);
      newBoard[row][col] = board[row][col] === num ? 0 : num;
      setBoard(newBoard);
      setConflicts(findConflicts(newBoard));
      setHighlightedNum(newBoard[row][col] || null);
      
      if (newBoard[row][col] !== 0) {
        const newNotes = notes.map(r => r.map(c => [...c]));
        newNotes[row][col] = [];
        setNotes(newNotes);
      }
    }
  };

  const handleUndo = () => {
    if (history.length === 0) return;
    const last = history[history.length - 1];
    setBoard(last.board);
    setNotes(last.notes);
    setHistory(history.slice(0, -1));
    setConflicts(findConflicts(last.board));
  };

  const handleHint = () => {
    if (!selected) return;
    const [row, col] = selected;
    if (initialBoard[row][col] !== 0) return;
    
    const newBoard = board.map(r => [...r]);
    newBoard[row][col] = solution[row][col];
    setBoard(newBoard);
    
    const newInitial = initialBoard.map(r => [...r]);
    newInitial[row][col] = solution[row][col];
    setInitialBoard(newInitial);
    
    setConflicts(findConflicts(newBoard));
  };

  const handleKeyPress = useCallback((e) => {
    if (!selected) return;
    const [row, col] = selected;
    
    if (e.key >= '1' && e.key <= '9') {
      handleNumberInput(parseInt(e.key));
    } else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
      if (initialBoard[row][col] === 0) {
        const newBoard = board.map(r => [...r]);
        newBoard[row][col] = 0;
        setBoard(newBoard);
        setConflicts(findConflicts(newBoard));
        setHighlightedNum(null);
      }
    } else if (e.key === 'ArrowUp' && row > 0) {
      setSelected([row - 1, col]);
    } else if (e.key === 'ArrowDown' && row < 8) {
      setSelected([row + 1, col]);
    } else if (e.key === 'ArrowLeft' && col > 0) {
      setSelected([row, col - 1]);
    } else if (e.key === 'ArrowRight' && col < 8) {
      setSelected([row, col + 1]);
    }
  }, [selected, board, initialBoard]);

  useEffect(() => {
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [handleKeyPress]);

  const isInSameRowColBox = (r1, c1, r2, c2) => {
    if (r1 === r2 || c1 === c2) return true;
    return Math.floor(r1 / 3) === Math.floor(r2 / 3) && Math.floor(c1 / 3) === Math.floor(c2 / 3);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
      <div className="max-w-2xl w-full">
        <div className="text-center mb-6">
          <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2 flex items-center justify-center gap-3">
            <Sparkles className="w-10 h-10 text-purple-400" />
            Sudoku
          </h1>
          <p className="text-purple-200">Modern & ÅžÄ±k Sudoku Oyunu</p>
        </div>

        <div className="bg-slate-800/50 backdrop-blur-lg rounded-2xl shadow-2xl p-6 border border-purple-500/20">
          <div className="flex justify-between items-center mb-4">
            <div className="flex gap-2">
              {['easy', 'medium', 'hard'].map(diff => (
                <button
                  key={diff}
                  onClick={() => setDifficulty(diff)}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${
                    difficulty === diff
                      ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/50'
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  }`}
                >
                  {diff === 'easy' ? 'Kolay' : diff === 'medium' ? 'Orta' : 'Zor'}
                </button>
              ))}
            </div>
            <div className="text-2xl font-mono text-purple-300 bg-slate-900/50 px-4 py-2 rounded-lg">
              {formatTime(time)}
            </div>
          </div>

          <div className="bg-slate-900/50 p-4 rounded-xl mb-4 inline-block">
            <div className="grid grid-cols-9 gap-0">
              {board.map((row, r) =>
                row.map((cell, c) => {
                  const isSelected = selected && selected[0] === r && selected[1] === c;
                  const isHighlighted = selected && isInSameRowColBox(selected[0], selected[1], r, c);
                  const isGiven = initialBoard[r][c] !== 0;
                  const hasConflict = conflicts[r][c];
                  const isSameNum = highlightedNum && cell === highlightedNum && cell !== 0;
                  
                  return (
                    <div
                      key={`${r}-${c}`}
                      onClick={() => handleCellClick(r, c)}
                      className={`
                        w-12 h-12 flex items-center justify-center text-xl font-semibold cursor-pointer
                        transition-all duration-150
                        ${c % 3 === 2 && c !== 8 ? 'border-r-4 border-purple-500/50' : 'border-r border-slate-600'}
                        ${r % 3 === 2 && r !== 8 ? 'border-b-4 border-purple-500/50' : 'border-b border-slate-600'}
                        ${c === 0 ? 'border-l-4 border-purple-500/50' : ''}
                        ${r === 0 ? 'border-t-4 border-purple-500/50' : ''}
                        ${isSelected ? 'bg-purple-600 text-white shadow-lg scale-105 z-10' : ''}
                        ${!isSelected && isHighlighted ? 'bg-slate-700/50' : ''}
                        ${!isSelected && !isHighlighted ? 'bg-slate-800/30' : ''}
                        ${isGiven ? 'text-purple-200 font-bold' : 'text-cyan-300'}
                        ${hasConflict ? '!bg-red-500/40 text-red-200' : ''}
                        ${isSameNum && !isSelected ? 'bg-cyan-600/30 ring-2 ring-cyan-500/50' : ''}
                        ${!isGiven ? 'hover:bg-slate-700' : ''}
                      `}
                    >
                      {cell !== 0 ? (
                        cell
                      ) : notes[r][c].length > 0 ? (
                        <div className="grid grid-cols-3 gap-0 w-full h-full text-[8px] text-slate-400 p-0.5">
                          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                            <span key={n} className="flex items-center justify-center">
                              {notes[r][c].includes(n) ? n : ''}
                            </span>
                          ))}
                        </div>
                      ) : null}
                    </div>
                  );
                })
              )}
            </div>
          </div>

          <div className="grid grid-cols-9 gap-2 mb-4">
            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
              <button
                key={num}
                onClick={() => handleNumberInput(num)}
                className="h-12 bg-gradient-to-br from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 
                  text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95"
              >
                {num}
              </button>
            ))}
          </div>

          <div className="flex gap-2 flex-wrap">
            <button
              onClick={newGame}
              className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 
                text-white font-medium py-3 px-4 rounded-lg shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2"
            >
              <RotateCcw className="w-5 h-5" />
              Yeni Oyun
            </button>
            
            <button
              onClick={() => setPencilMode(!pencilMode)}
              className={`flex-1 font-medium py-3 px-4 rounded-lg shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2 ${
                pencilMode
                  ? 'bg-gradient-to-r from-yellow-600 to-orange-600 text-white'
                  : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
              }`}
            >
              <Pencil className="w-5 h-5" />
              Notlar
            </button>
            
            <button
              onClick={handleHint}
              disabled={!selected}
              className="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 
                text-white font-medium py-3 px-4 rounded-lg shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2
                disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
            >
              <Lightbulb className="w-5 h-5" />
              Ä°pucu
            </button>
            
            <button
              onClick={handleUndo}
              disabled={history.length === 0}
              className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 
                text-white font-medium py-3 px-4 rounded-lg shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2
                disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
            >
              <Undo className="w-5 h-5" />
              Geri Al
            </button>
            
            <button
              onClick={() => setIsPlaying(!isPlaying)}
              className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 
                text-white font-medium py-3 px-4 rounded-lg shadow-lg transition-all hover:scale-105 flex items-center justify-center"
            >
              {isPlaying ? <Pause className="w-5 h-5" /> : <Play className="w-5 h-5" />}
            </button>
          </div>
        </div>

        <div className="mt-4 text-center text-purple-300 text-sm">
          <p>ðŸŽ® Ok tuÅŸlarÄ± ile hareket | 1-9 tuÅŸlarÄ± ile sayÄ± gir | Backspace/Delete ile sil</p>
        </div>
      </div>
    </div>
  );
};

